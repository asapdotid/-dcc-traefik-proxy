ARG TRAEFIK_VERSION
FROM traefik:${TRAEFIK_VERSION} as base

RUN apk --no-cache add \
    sed \
    tzdata \
    openssl \
    perl-mime-base64

# Timezone
ARG TIMEZONE
ENV TZ=${TIMEZONE}
RUN ln -snf /usr/share/zoneinfo/$TIMEZONE /etc/localtime && echo $TIMEZONE > /etc/timezone

ARG TRAEFIK_LOG_LEVEL
ARG TRAEFIK_DOMAIN_NAME
ARG TRAEFIK_DOCKER_NETWORK
ARG TRAEFIK_DOCKER_ENTRYPOINT
ARG TRAEFIK_API_DASHBOARD
ARG TRAEFIK_API_DASHBOARD_SUBDOMAIN
ARG TRAEFIK_API_INSECURE
ARG TRAEFIK_BASIC_AUTH_USERNAME
ARG TRAEFIK_BASIC_AUTH_PASSWORD_HASH
ENV TRAEFIK_LOG_LEVEL ${TRAEFIK_LOG_LEVEL}
ENV TRAEFIK_DOMAIN_NAME ${TRAEFIK_DOMAIN_NAME}
ENV TRAEFIK_DOCKER_NETWORK ${TRAEFIK_DOCKER_NETWORK}
ENV TRAEFIK_DOCKER_ENTRYPOINT ${TRAEFIK_DOCKER_ENTRYPOINT}
ENV TRAEFIK_API_DASHBOARD ${TRAEFIK_API_DASHBOARD}
ENV TRAEFIK_API_DASHBOARD_SUBDOMAIN ${TRAEFIK_API_DASHBOARD_SUBDOMAIN}
ENV TRAEFIK_API_INSECURE ${TRAEFIK_API_INSECURE}
ENV TRAEFIK_BASIC_AUTH_USERNAME ${TRAEFIK_BASIC_AUTH_USERNAME}
ENV TRAEFIK_BASIC_AUTH_PASSWORD_HASH ${TRAEFIK_BASIC_AUTH_PASSWORD_HASH}

COPY ./images/traefik/config/traefik.yml /etc/traefik/traefik.yml
COPY ./images/traefik/config/dynamic/ /etc/traefik/dynamic/

COPY ./images/traefik/setup.sh /
RUN chmod a+x /setup.sh

ENTRYPOINT [ "/setup.sh" ]

CMD [ "traefik" ]

FROM base as local